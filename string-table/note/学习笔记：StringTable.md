# å­—ç¬¦ä¸²çš„å‰ç”Ÿä»Šä¸–

## å¦‚ä½•å‡ºç”Ÿ

å­—ç¬¦ä¸²çš„6ç§åˆ›å»ºæ–¹å¼

* ä½¿ç”¨`charæ•°ç»„é…åˆnewæ¥åˆ›å»º
* ä½¿ç”¨byteæ•°ç»„é…åˆnewæ¥åˆ›å»º
* ä½¿ç”¨intæ•°ç»„é…åˆnewæ¥åˆ›å»º
* ä½¿ç”¨å·²æœ‰å­—ç¬¦ä¸²é…åˆnewæ¥åˆ›å»º
* ä½¿ç”¨å­—é¢é‡åˆ›å»º
* ä½¿ç”¨+è¿ç®—ç¬¦æ‹¼æ¥åˆ›å»ºå­—ç¬¦ä¸²

## charæ•°ç»„åˆ›å»º

> æ³¨æ„ï¼šä»Java9å¼€å§‹ï¼ŒStringçš„å†…éƒ¨ç»“æ„ç”±`char[]`å˜æˆäº†`byte[]`ã€‚

æœ€åŸºæœ¬çš„åˆ›å»ºæ–¹å¼ï¼Œå› ä¸ºå­—ç¬¦ä¸²å°±æ˜¯å°†å­—ç¬¦ä¸²æ¥èµ·æ¥ã€‚

```
String s = new String(new char[]{'a', 'b', 'c'});
```

å®ƒçš„å†…éƒ¨ç»“æ„å¦‚ä¸‹ï¼ˆJava8ï¼‰ï¼š

![](å­¦ä¹ ç¬”è®°ï¼šStringTable.assets/0d8aa148.png)

å…¶ä¸­ï¼Œ97å…¶å®å°±æ˜¯'a'ï¼Œ98å…¶å®å°±æ˜¯'b'ï¼Œ99éª‘å£«å°±æ˜¯'c'ã€‚ï¼ˆæ ¹æ®Unicodeç¼–ç è¡¨ï¼‰

## byteæ•°ç»„åˆ›å»º

> æ³¨æ„ï¼šä»Java9å¼€å§‹ï¼ŒStringçš„å†…éƒ¨ç»“æ„ç”±`char[]`å˜æˆäº†`byte[]`ã€‚

ä»ç½‘ç»œä¼ é€’è¿‡æ¥çš„æ•°æ®ï¼Œæˆ–æ˜¯é€šè¿‡IOè¯»å–åˆ°çš„æ•°æ®ï¼Œéƒ½æœ‰ä»byteæ•°ç»„è½¬åŒ–ä¸ºå­—ç¬¦ä¸²çš„éœ€æ±‚ã€‚

```
String s = new String(new byte[]{97,98,99});
```

ä¸Šè¿°çš„`new byte[]{97, 98, 99}`å°±å¯ä»¥æ˜¯ï¼š

* ä»ç½‘ç»œï¼ˆä¾‹å¦‚ä¸€ä¸ªæµè§ˆå™¨çš„httpè¯·æ±‚ï¼‰ä¼ é€’è¿‡æ¥çš„å­—èŠ‚æ•°æ®ã€‚
* ä»IOï¼ˆä¾‹å¦‚ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼‰è¯»å–åˆ°çš„æ•°æ®ã€‚

å®ƒçš„å†…éƒ¨ç»“æ„å…¶å®ä¸ç”±charæ•°ç»„åˆ›å»ºçš„æƒ…å†µæ˜¯ä¸€æ ·çš„ï¼Œ`byte[]`ä¼šåœ¨æ„é€ æ—¶è¢«è½¬åŒ–ä¸º`char[]`ã€‚

![](å­¦ä¹ ç¬”è®°ï¼šStringTable.assets/0d8aa148.png)

ä¸€ä¸ªbyteå 1ä¸ªå­—èŠ‚ï¼Œä¸€ä¸ªcharå¯èƒ½å 1~3ä¸ªå­—èŠ‚ï¼ˆUTF-8ï¼‰ï¼Œä¹Ÿå¯èƒ½å 2ä¸ªå­—èŠ‚ï¼ˆUTF-16ï¼‰ã€‚

Javaä¸­çš„charå­—ç¬¦éƒ½æ˜¯ä»¥unicodeç¼–ç çš„ã€‚

## intæ•°ç»„åˆ›å»º

æœ‰æ—¶å€™æˆ‘ä»¬è¿˜éœ€è¦ç”¨ä¸¤ä¸ªcharè¡¨ç¤ºä¸€ä¸ªå­—ç¬¦ï¼Œæ¯”å¦‚ emojiè¡¨æƒ…ğŸ˜‚ï¼Œå®ƒç”¨unicodeç¼–ç è¡¨ç¤ºä¸º0x1F602ï¼Œå­˜å‚¨èŒƒå›´å·²ç»è¶…è¿‡äº†charèƒ½è¡¨ç¤ºçš„æœ€å¤§å€¼0xFFFFï¼Œå› æ­¤éœ€è¦ä½¿ç”¨int[]æ¥æ„é€ è¿™æ ·çš„å­—ç¬¦ä¸²ï¼Œå¦‚ä¸‹ï¼š

```
String s = new String(new int[]{0x1F602},0,1);
```

è½¬æ¢è¿‡ç¨‹å¦‚å›¾æ‰€ç¤ºï¼š

![image-20200228220030725](å­¦ä¹ ç¬”è®°ï¼šStringTable.assets/image-20200228220030725.png)

## ä»å·²æœ‰å­—ç¬¦ä¸²åˆ›å»º

è¿™ç§åˆ›å»ºæ–¹å¼æœ€ä¸ºç®€å•ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„ä¸¤ä¸ªå­—ç¬¦ä¸²å¯¹è±¡å¼•ç”¨åŒä¸€ä¸ª`char[]`å¯¹è±¡ã€‚

```
String s1 = new String(new char[]{'a', 'b', 'c'});
String s2 = new String(s1);
```

å†…å­˜ç»“æ„å¦‚ä¸‹ï¼š

![image-20200228220535422](å­¦ä¹ ç¬”è®°ï¼šStringTable.assets/image-20200228220535422.png)

## å­—é¢é‡åˆ›å»º

è¿™ç§åˆ›å»ºæ–¹å¼æœ€ä¸ºæˆ‘ä»¬ç†Ÿæ‚‰ã€‚

```
public static void main(String[] args){
	String s = "abc";
} 
```

`â€œabcâ€`è¢«ç§°ä¸ºå­—ç¬¦ä¸²å­—é¢é‡ï¼ˆString literalï¼‰ï¼Œæ‹¥æœ‰éå¯¹è±¡ã€æ‡’åŠ è½½ã€ä¸é‡å¤ä¸‰ç‚¹ç‰¹æ€§ã€‚

### éå¯¹è±¡

ä¸¥æ ¼æ¥è¯´ï¼Œå­—é¢é‡åœ¨ä»£ç è¿è¡Œåˆ°å®ƒæ‰€åœ¨è¯­å¥ä¹‹å‰ï¼Œå®ƒè¿˜ä¸æ˜¯å­—ç¬¦ä¸²å¯¹è±¡ã€‚è¦ç†è§£ä»å­—é¢é‡ç¼–ç¨‹å­—ç¬¦ä¸²å¯¹è±¡çš„è¿‡ç¨‹ï¼Œéœ€è¦ä»å­—èŠ‚ç çš„è§’åº¦æ¥åˆ†æã€‚åœ¨ä¸Šé¢çš„javaä»£ç è¢«ç¼–è¯‘ä¸ºclassæ–‡ä»¶åï¼Œ`â€œabcâ€`å­˜å‚¨äºâ€œç±»æ–‡ä»¶å¸¸é‡æ± â€ä¸­ã€‚

```
Constant pool: //å¸¸é‡æ± 
	#1 = Methodref #19.#41   //java/lang/object."<init>"()
	#2 = String #42          //abc
	...
```

å½“classå®Œæˆç±»åŠ è½½åï¼Œ`â€œabcâ€`è¿™ä¸ªå­—é¢é‡è¢«å­˜å‚¨äºâ€œè¿è¡Œæ—¶å¸¸é‡æ± â€ï¼ˆå½’å±äºæ–¹æ³•åŒº/å…ƒç©ºé—´ï¼‰ä¸­ï¼Œå…¶ä¸­#1 #2éƒ½ä¼šè¢«ç¿»è¯‘ä¸ºè¿è¡Œæ—¶çœŸæ­£çš„å†…å­˜åœ°å€ã€‚

å†çœ‹ä¸€ä¸‹classä¸­mainæ–¹æ³•çš„å­—èŠ‚ç 

```
public static void main(java.lang.String[]); //
	descriptor: ([Ljava/lang/String;)V
	flags: ACC_PUBLIC, ACC_STATIC
	Code:
	  stack=1, locals=2, args_size=1
		0: 1dc #2
		2: astore_1
		3: return
		...
```

å°†æ¥mainæ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œå°±ä¼šæ‰§è¡Œé‡Œé¢çš„å­—èŠ‚ç æŒ‡ä»¤ï¼š

```
0: 1dc #2      //åˆ›å»ºå­—ç¬¦ä¸²å¸¸é‡åˆ°è¿è¡Œæ—¶å¸¸é‡æ± ä¸­
2: astore_1    //å°†å­—ç¬¦ä¸²å¸¸é‡èµ‹å€¼ç»™å±€éƒ¨å˜é‡
3: return      //ä»æ–¹æ³•ä¸­è¿”å›
```

![image-20200228221916506](å­¦ä¹ ç¬”è®°ï¼šStringTable.assets/image-20200228221916506.png)

### æ‡’åŠ è½½

å½“ç¬¬ä¸€æ¬¡ç”¨åˆ°`â€œabc"`å­—é¢é‡æ—¶ï¼Œæ‰ä¼šåˆ›å»ºå¯¹åº”çš„å­—ç¬¦ä¸²å˜é‡ã€‚

å¯ä»¥åœ¨IDEAçš„debugç•Œé¢ä¸­çš„memoryå·¥å…·æ¥æŸ¥çœ‹å­—ç¬¦ä¸²å¯¹è±¡çš„æ•°é‡ï¼ˆä»¥Stringä¸ºå…³é”®å­—æŸ¥è¯¢ï¼‰

### ä¸é‡å¤

åŒä¸€ä¸ªç±»ä¸­çš„å€¼ç›¸åŒçš„å­—ç¬¦ä¸²å­—é¢é‡ï¼Œå…¶å®åªæœ‰ä¸€ä»½ã€‚

ä¸åŒçš„ç±»å¸¸é‡æ± æ˜¯ä¸ä¸€æ ·çš„ã€‚â€œç±»æ–‡ä»¶å˜é‡æ± â€åŒ…æ‹¬â€œè¿è¡Œæ—¶å¸¸é‡æ± â€éƒ½æ˜¯ä»¥ç±»ä¸ºå•ä½çš„ã€‚

è¿™æ—¶å€™è™½ç„¶â€œå­—é¢é‡â€æ˜¯ä¸¤ä»½ï¼Œä½†æ˜¯â€œå­—ç¬¦ä¸²å¯¹è±¡â€ä»…æœ‰ä¸€ä¸ªã€‚

## æ‹¼æ¥åˆ›å»º

å¯ä»¥é€šè¿‡+è¿ç®—ç¬¦é‡ä¸¤ä¸ªå­—ç¬¦ä¸²ï¼ˆå…¶ä¸­ä¸€ä¸ªä¹Ÿå¯ä»¥æ˜¯å…¶ä»–ç±»å‹ï¼‰æ‹¼æ¥ä¸ºä¸€ä¸ªæ–°å­—ç¬¦ä¸²ã€‚

```
//ä¾‹1
String s = "a" + "b";
//ä¾‹2
final String x1 = "b";
String s1 = "a" + x1;
//ä¾‹3
String x2 = "b";
String s2 = "a" + x2;
//ä¾‹4
String s3 = "a" + 1;
```

å…¶ä¸­ä¾‹1å’Œä¾‹2çš„åŸç†æ˜¯ä¸€æ ·çš„ï¼Œä¾‹3å’Œä¾‹4çš„åŸç†æ˜¯ä¸€æ ·çš„ã€‚

* ä¾‹1ï¼šå¹¶æ²¡æœ‰çœŸæ­£çš„æ‹¼æ¥æ“ä½œå‘ç”Ÿï¼Œä»æºç ç¼–è¯‘ä¸ºå­—èŠ‚ç æ—¶ï¼Œjavacå°±å·²ç»æŠŠ`â€œaâ€`å’Œ`"b"`ä¸²åœ¨ä¸€èµ·äº†ã€‚è¿™æ˜¯ä¸€ç§ç¼–è¯‘æœŸçš„ä¼˜åŒ–å¤„ç†
* ä¾‹2ï¼šx1æ˜¯å¸¸é‡ï¼Œå…¶å€¼ä¸å¯æ”¹å˜ï¼ˆå¹¶ä¸”å­—ç¬¦ä¸²çš„å†…å®¹æœ¬èº«ä¹Ÿä¸å¯å˜ï¼‰ï¼ŒåŒä¸Šã€‚
* ä¾‹3ï¼šx2æ˜¯å˜é‡ï¼Œä¸èƒ½åœ¨ç¼–è¯‘æœŸé—´ç¡®å®šå€¼ï¼Œæœ€åå­—ç¬¦ä¸²çš„+æ“ä½œç¬¦ä¼šè¢«è½¬åŒ–ä¸º`StringBuilder`æˆ–`StringBuffer`çš„`append`æ–¹æ³•ã€‚
* ä¾‹4ï¼šåŒä¸Šã€‚

å¯¹äºå­—ç¬¦ä¸²çš„+æ“ä½œç¬¦çš„è¯´æ˜

```
String x = "b";
String s = "a" + x; 

//ç­‰åŒäºä¸‹é¢è¿™å¥ï¼ˆåœ¨ç¼–è¯‘æ—¶ä¼šè¢«æ›¿æ¢ï¼‰
//StringBuilderå’ŒStringBufferçš„toStringæ–¹æ³•çš„å®ç°ï¼Œå°±æ˜¯åˆ©ç”¨å®ƒä»¬çš„valueå­—æ®µç”Ÿæˆæ–°çš„å­—ç¬¦ä¸²
String s1 = new StringBuilder().append("a").append(x).toString();
```

## JDK9ä¹‹åçš„æ”¹å˜

> æ³¨æ„ï¼šä»Java9å¼€å§‹ï¼Œä½¿ç”¨invokedynamicæŒ‡ä»¤æ‰©å±•äº†å­—ç¬¦ä¸²çš„æ‹¼æ¥çš„å®ç°æ–¹å¼

ä»JDK9å¼€å§‹ï¼ŒStringçš„å†…éƒ¨å­˜å‚¨æ–¹å¼ä»¥åŠæ‹¼æ¥æ–¹å¼å‘ç”Ÿäº†è¾ƒå¤§çš„æ”¹å˜ã€‚

* ä¸å†ä½¿ç”¨`char[]`ç²—ç³™ä½ å­—ç¬¦ï¼Œæ”¹ä¸ºäº†`byte[]`ï¼Œç›®çš„æ˜¯èŠ‚çº¦å†…å­˜ã€‚
* ä½¿ç”¨invokedynamicæŒ‡ä»¤æ‰©å±•äº†å­—ç¬¦ä¸²çš„æ‹¼æ¥çš„å®ç°æ–¹å¼ã€‚

### å†…å­˜ç»“æ„æ”¹å˜

ä¾‹å¦‚ï¼Œå­—ç¬¦ä¸²ä¸­ä»…æœ‰æ‹‰ä¸å­—ç¬¦æ—¶ï¼š

```
String s = new String (new byte[]{97, 98, 99});
```

![image-20200228224707273](å­¦ä¹ ç¬”è®°ï¼šStringTable.assets/image-20200228224707273.png)

ä¾‹å¦‚ï¼Œå­—ç¬¦ä¸²ä¸­æœ‰ä¸­æ–‡å­—ç¬¦

```
String s = new String(new byte[]{0xd5, (byte)0xc5},Charset.forName("gbk"));
```

![image-20200228225134510](å­¦ä¹ ç¬”è®°ï¼šStringTable.assets/image-20200228225134510.png)

ä¾‹å¦‚ï¼Œå­—ç¬¦ä¸²ä¸­æ—¢æœ‰ä¸­æ–‡å­—ç¬¦ä¹Ÿæœ‰æ‹‰ä¸å­—ç¬¦ï¼šï¼ˆè¿™æ—¶ä¼šæŠŠæ‰€æœ‰å­—ç¬¦è§†ä¸ºunicodeå¤„ç†ï¼‰

```
String s = new String(new byte[]{0xd5, (byte)0xc5, 97},Charset.forName("gbk"));
```

![image-20200228225258575](å­¦ä¹ ç¬”è®°ï¼šStringTable.assets/image-20200228225258575.png)

å…¶ä¸­coderå±æ€§ç”¨äºåŒºåˆ†å­—ç¬¦ä¸²çš„ç¼–ç ã€‚0è¡¨ç¤ºï¼ˆä»…æœ‰ï¼‰æ‹‰ä¸å­—ç¬¦ï¼Œ1è¡¨ç¤ºï¼ˆåŒ…å«ï¼‰unicodeå­—ç¬¦ã€‚

### æ‹¼æ¥æ–¹å¼çš„æ”¹å˜

ä¾‹å¦‚ï¼š

```
public static void main(String[] args){
	String x = "b";
	String s = "a" + x;
}
```

å¸¸é‡æ± 

```
Constant pool:
	#1 = Methodref #5.#22   //java/lang/object."<init>"()
	#2 = String #23         //b
	...
```

ä¸»æ–¹æ³•

```
public static void main(java.lang.String[]); //
	descriptor: ([Ljava/lang/String;)V
	flags: ACC_PUBLIC, ACC_STATIC
	Code:
	  stack=1, locals=2, args_size=1
		0: 1dc #2
		2: astore_1
		3: aload_1
		4: invokedynamic #3, 0
	[Ljava/lang/String;]Ljava/lang/String;
		9: astore_2
		10: return
		...
```

 å¯¹äºå­—ç¬¦ä¸²çš„+æ“ä½œç¬¦çš„è¯´æ˜

```
String x = "b";
String s = "a" + x;

//ç­‰åŒäºä¸‹é¢è¿™å¥ï¼ˆåœ¨ç¼–è¯‘æ—¶ä¼šè¢«æ›¿æ¢ï¼‰
//ç¼–è¯‘å™¨ä¼šæä¾›lookupï¼Œç”¨æ¥æŸ¥æ‰¾MethodHandle
MethodHandles.Lookup lookup = MethodHandles.lookup();
CallSite callSite = StringConcatFactory.makeConcatWithConstants(
    lookup,
    //æ–¹æ³•åï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆ
    "arbitrary",
    //æ–¹æ³•çš„ç­¾åï¼Œå‚æ•°åˆ†åˆ«ä¸ºè¿”å›å€¼ç±»å‹å’Œå‚æ•°ç±»å‹
    MethodType.methodType(String.class,String.class),
    //å…·ä½“å¤„æ–¹æ ¼å¼ï¼Œå…¶ä¸­ã€1è¡¨ç¤ºå˜é‡çš„å ä½ç¬¦ï¼Œç”¨æ¥è¢«xæ›¿ä»£
    "a\1"
);
//ç”¨æ¥åå°„æ‰§è¡Œæ‹¼æ¥æ–¹æ³•
String s = (String) callSite.getTarget().invoke(x);
```

 ä¸»è¦æ˜¯ä¸ºäº†å¯¹å­—ç¬¦ä¸²çš„æ‹¼æ¥åšå„ç§æ‰©å±•ä¼˜åŒ–ï¼Œå¤šäº†æ‰©å±•é€”å¾„ã€‚å…¶ä¸­æœ€ä¸ºé‡è¦çš„æ˜¯MethodHandleï¼Œå®ƒä½¿ç”¨äº†ç­–ç•¥æ¨¡å¼ç”Ÿæˆï¼ŒJDKæä¾›çš„æ‰€æœ‰ç­–ç•¥å¯ä»¥åœ¨StringconcatFactory.Strategeä¸­æ‰¾åˆ°ã€‚

| ç­–ç•¥å                | å†…éƒ¨è°ƒç”¨                                     | è§£é‡Š                                      |
| --------------------- | -------------------------------------------- | ----------------------------------------- |
| BC_SB                 | å­—ç¬¦ä¸²æ‹¼æ¥ç”ŸæˆStringBuilderä»£ç               | ç­‰ä»·äº`new StringBuilder()`               |
| BC_SB_SIZED           | å­—ç¬¦ä¸²æ‹¼æ¥ç”ŸæˆStringBuilderä»£ç               | ç­‰ä»·äº`new StringBuilder(n)`ï¼Œnä¸ºé¢„ä¼°å¤§å° |
| BC_SB_SIZED_EXACT     | å­—ç¬¦ä¸²æ‹¼æ¥ç”ŸæˆStringBuilderä»£ç               | ç­‰ä»·äº`new StringBuilder(n)`ï¼Œnä¸ºå‡†ç¡®å¤§å° |
| MH_SB_SIZED           | MethodHandleç”ŸæˆStringBuilderä»£ç             | ç­‰ä»·äº`new StringBuilder(n)`ï¼Œnä¸ºé¢„ä¼°å¤§å° |
| MH_SB_SIZED_EXACT     | MethodHandleç”ŸæˆStringBuilderä»£ç             | ç­‰ä»·äº`new StringBuilder(n)`ï¼Œnä¸ºå‡†ç¡®å¤§å° |
| MH_INLINE_SIZED_EXACT | MethodHandleå†…éƒ¨ä½¿ç”¨å­—èŠ‚æ•°ç»„ç›´æ¥æ„é€ å‡ºString | é»˜è®¤ç­–ç•¥                                  |

å¦‚æœæƒ³æ”¹å˜ç­–ç•¥ï¼Œå¯ä»¥åœ¨è¿è¡Œæ—¶æ·»åŠ JVMå‚æ•°ï¼Œä¾‹å¦‚å°†ç­–ç•¥æ”¹ä¸ºBC_SBã€‚

```
-Djava.lang.invoke.stringConcat=BC_SB
-Djava.lang.invoke.stringConcat.debug=true
-Djava.lang.invoke.stringConcat.dumpClasses=åŒ¿åç±»å¯¼å‡ºè·¯å¾„
```

è¿˜æœ‰ä¸€ç§é€‰æ‹©ï¼Œæ˜¯åœ¨javacç¼–è¯‘æ—¶ä»ä½¿ç”¨1.5çš„æ–¹æ³•æ‹¼æ¥å­—ç¬¦ä¸²ï¼Œè€Œä¸æ˜¯é‡‡ç”¨invokedynamicï¼Œé‚£å°±æ˜¯åœ¨javacè¿è¡Œæ—¶åŠ ä¸Šå‚æ•°ï¼š

```
-XDstringConcat=inline
```

é»˜è®¤ç­–ç•¥ä¸ºMH_INLINE_SIZED_EXACTï¼Œä½¿ç”¨å­—èŠ‚æ•°ç»„ç›´æ¥æ„é€ å‡ºString

ä¾‹å¦‚æœ‰ä¸‹é¢çš„å­—ç¬¦ä¸²æ‹¼æ¥ä»£ç 

```
String x = "b"
String s = "a" + x + "c" + "d";
```

ä½¿ç”¨è¿™ä¸ªç­–ç•¥åï¼Œå†…éƒ¨ä¼šæ‰§è¡Œå¦‚ä¸‹ç­‰ä»·è°ƒç”¨ï¼š

```
String x = "b";
//é¢„å…ˆåˆ†é…å­—ç¬¦ä¸²éœ€è¦çš„å­—èŠ‚æ•°ç»„
byte[] buf = new byte[4];
//åˆ›å»ºæ–°å­—ç¬¦ä¸²ï¼Œè¿™æ—¶å†…éƒ¨å­—èŠ‚æ•°ç»„å€¼ä¸º[0, 0, 0, 0]
String s = StringConcatHelper.newString(buf, 0);
//æ‰§è¡Œæ‹¼æ¥æ“ä½œï¼Œå­—ç¬¦ä¸²å†…éƒ¨å­—èŠ‚æ•°ç»„å€¼å˜ä¸º[97, 0, 0 ,0]
StringConcatHelper.prepend(1,buf,"a");
//æ‰§è¡Œæ‹¼æ¥æ“ä½œï¼Œå­—ç¬¦ä¸²å†…éƒ¨å­—èŠ‚æ•°ç»„å€¼å˜ä¸º[97, 98, 0, 0]
StringConcatHelper.prepend(2, buf, x);
//æ‰§è¡Œæ‹¼æ¥æ“ä½œï¼Œå­—ç¬¦ä¸²å†…éƒ¨å­—èŠ‚æ•°ç»„å€¼ä¸º[97, 98, 99, 100]
//åˆ°æ­¤æ‹¼æ¥å®Œæ¯•
```

### æ³¨æ„

* StringConcatHelperå¯¹å¤–æ˜¯ä¸å¯è§çš„ï¼Œå› æ­¤æ— æ³•ç›´æ¥æµ‹è¯•ï¼Œåªèƒ½åå°„æµ‹è¯•ã€‚
* prependæ–¹æ³•å¯ä»¥ç›´æ¥ä¿®æ”¹å­—ç¬¦ä¸²ä¸­byteæ•°ç»„å±æ€§çš„å†…å®¹ã€‚è¿™æ˜¯å…è®¸çš„ï¼Œå› ä¸ºæ˜¯åŒä¸€ä¸ªbyteæ•°ç»„ã€‚

## æ¨¡ä»¿BC_SBç­–ç•¥

### æ–¹æ³•æ‰‹åŠ¨ç”Ÿæˆ

[StringConcatDemo.java](../src/main/java/com/windea/study/stringtable/StringConcatDemo1.java)

### å­—èŠ‚ç ç”Ÿæˆæ–¹æ³•

[StringConcatDemo2.java](../src/main/java/com/windea/study/stringtable/StringConcatDemo2.java)

JDK9å¯ä»¥é€‚é…ç”Ÿæˆä¸åŒçš„å‚æ•°ä¸ªæ•°ã€ç±»å‹çš„MethodHandleï¼ŒåŸç†å°±æ˜¯è¿™æ ·ã€‚

# å­—ç¬¦ä¸²ä¹‹å®¶â€”â€”StringTable

## å®¶å…»ä¸é‡ç”Ÿ

å…¶å®å­—ç¬¦ä¸²ä¹Ÿä¸€æ ·ï¼Œåˆ†ä¸ºå®¶å…»çš„å’Œé‡ç”Ÿçš„ã€‚

é™¤äº†å­—é¢é‡æ–¹å¼åˆ›å»ºçš„å­—ç¬¦ä¸²æ˜¯å®¶å…»çš„ï¼Œå…¶ä»–æ–¹æ³•åˆ›å»ºçš„å­—ç¬¦ä¸²éƒ½æ˜¯é‡ç”Ÿçš„ã€‚

* å­—é¢é‡æ–¹å¼åˆ›å»ºçš„å­—ç¬¦ä¸²ä¼šæ”¾å…¥StringTableä¸­ï¼ŒStringTableç®¡ç†çš„å­—ç¬¦ä¸²æ‰å…·æœ‰ä¸é‡å¤çš„ç‰¹æ€§ï¼Œè¿™ç§å°±åƒæ˜¯å®¶å…»çš„ã€‚
* å…¶ä»–æ–¹å¼åˆ›å»ºçš„å­—ç¬¦ä¸²æœ¬è´¨ä¸Šéƒ½æ˜¯é€šè¿‡newæ¥åˆ›å»ºï¼Œå®ƒä»¬éƒ½æ˜¯åœ¨å †ä¸­åˆ›å»ºæ–°çš„å­—ç¬¦ä¸²å¯¹è±¡ï¼Œä¸ä¼šè€ƒè™‘å­—ç¬¦ä¸²é‡ä¸é‡å¤ï¼Œè¿™ç§å°±åƒæ˜¯é‡ç”Ÿçš„ã€‚é‡ç”Ÿå­—ç¬¦ä¸²çš„ç¼ºç‚¹å°±æ˜¯å¦‚æœå­˜åœ¨å¤§é‡å€¼ç›¸åŒçš„å­—ç¬¦ä¸²ï¼Œå¯¹å†…å­˜çš„å ç”¨å°±ä¼šéå¸¸ä¸¥é‡ã€‚

å¦‚ä½•ä¿è¯å®¶å…»çš„å­—ç¬¦ä¸²å¯¹è±¡ä¸é‡å¤ï¼šJDKä½¿ç”¨äº†StingTableæ¥è§£å†³ï¼ŒStringTableæ˜¯é‡‡ç”¨c++ä»£ç ç¼–å†™çš„ï¼Œæ•°æ®ç»“æ„ä¸Šå°±æ˜¯ä¸€ä¸ªhashè¡¨ï¼Œå­—ç¬¦ä¸²å¯¹è±¡å……å½“äº†hashè¡¨ä¸­çš„keyï¼Œkeçš„ä¸é‡å¤æ€§æ˜¯hashè¡¨çš„åŸºæœ¬ç‰¹å¾ã€‚

![](å­¦ä¹ ç¬”è®°ï¼šStringTable.assets/2c539bd3.png)

å½“ä»£ç è¿è¡Œåˆ°ä¸€ä¸ªå­—é¢é‡`"abc"`æ—¶ï¼Œä¼šé¦–å…ˆæ£€æŸ¥StringTableä¸­æœ‰æ²¡æœ‰ç›¸åŒçš„keyï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™åˆ›å»ºæ–°å­—ç¬¦ä¸²å¯¹è±¡åŠ å…¥ï¼Œå¦åˆ™ç›´æ¥è¿”å›å·²æœ‰çš„å­—ç¬¦ä¸²å¯¹è±¡ã€‚

## æ”¶ç•™é‡ç”Ÿå­—ç¬¦ä¸²

é‡ç”Ÿçš„å­—ç¬¦ä¸²ä¹Ÿæœ‰æœºä¼šå¾—åˆ°æ”¶ç•™ã€‚å­—ç¬¦ä¸²æä¾›äº†internæ–¹æ³•æ¥å®ç°å»é‡ï¼Œè®©å­—ç¬¦ä¸²å¯¹è±¡æœ‰æœºä¼šå—åˆ°StringTableçš„ç®¡ç†ã€‚è¿™ä¸ªæ–¹æ³•ä¼šå°è¯•å°†è°ƒç”¨è€…æ”¾å…¥StringTableã€‚

```
public native String intern();
```

* å¦‚æœStringTableä¸­å·²æœ‰ï¼Œåˆ™æ€»ä¼šè¿”å›StringTableä¸­çš„å­—ç¬¦ä¸²å¯¹è±¡ã€‚
* ï¼ˆJDK1.6ï¼‰å¦‚æœStringTableä¸­æ²¡æœ‰ï¼Œåˆ™ä¼šå°†å½“å‰å­—ç¬¦ä¸²å¯¹è±¡çš„å¤åˆ¶æ”¾å…¥StringTableï¼Œç„¶åè¿”å›å¤åˆ¶ã€‚
* ï¼ˆJDK1.7ä»¥ä¸Šï¼‰å¦‚æœStringTableä¸­æ²¡æœ‰ï¼Œåˆ™ä¼šå°†å½“å‰å­—ç¬¦ä¸²å¯¹è±¡æ”¾å…¥StringTableï¼Œç„¶åè¿”å›æœ¬èº«ã€‚

## å®¶çš„å¥½å¤„

ä½¿ç”¨`String.intern()`æ–¹æ³•ä»¥èŠ‚çº¦JVMå†…å­˜ã€‚

## å®¶çš„ä½ç½®

StringTableçš„ä½ç½®ï¼ˆ1.6ï¼‰

![](å­¦ä¹ ç¬”è®°ï¼šStringTable.assets/39dcf38b.png)

StringTableçš„ä½ç½®ï¼ˆ1.8ï¼‰

![](å­¦ä¹ ç¬”è®°ï¼šStringTable.assets/5d6ad3b7.png)

Java8å°†StringTableä»æ–¹æ³•åŒºä¸€é“å †å†…å­˜çš„ä¸­çš„å‡ ç‚¹åŸå› 

* æ°¸ä¹…åŒºçš„åƒåœ¾å›æ”¶éœ€è¦Full GCã€‚
* å †å†…å­˜çš„åƒåœ¾å›æ”¶éœ€è¦Minor GCï¼Œå›æ”¶æ—¶é—´è¾ƒå°‘ï¼Œå›æ”¶é€Ÿåº¦æ›´å¿«ã€‚

å¦‚ä½•è¯æ˜ï¼š

* 1.6ä¸­ä¸æ–­å°†å­—ç¬¦ä¸²ç”¨internåŠ å…¥StringTableï¼Œæœ€åæ’‘çˆ†çš„æ˜¯æ°¸ä¹…åŒºå†…å­˜ï¼Œä¸ºäº†è®©é”™è¯¯å¿«é€Ÿå‡ºç°ï¼Œå°†å†…å­˜è®¾ç½®çš„å°ä¸€äº›ï¼š`-XX:MaxPermSize=10m`ï¼Œæœ€ç»ˆä¼šå‡ºç°`java.lang.OutOfMemoryError: PermGen space`ã€‚
* 1.8ä¸­ä¸æ–­å°†å­—ç¬¦ä¸²ç”¨internåŠ å…¥StringTableï¼Œæœ€åæ’‘çˆ†çš„æ˜¯å †å†…å­˜ï¼Œä¸ºäº†è®©é”™è¯¯å¿«é€Ÿå‡ºç°ï¼Œå°†å †å†…å­˜è®¾ç½®çš„å°ä¸€äº›ï¼š`-Xxx10m -XX:-UseGCOverheadLimit`ï¼Œæœ€åä¸€ä¸ªè™šæ‹Ÿå™¨å‚æ•°æ˜¯é¿å…GCé¢‘ç¹å¼•èµ·å…¶ä»–é”™è¯¯ï¼Œè€Œä¸æ˜¯æˆ‘ä»¬æœŸæœ›çš„`java.lang.OutOfMemoryError: Java heap space`ã€‚

[InternDemo.java](../src/main/java/com/windea/study/stringtable/InternDemo.java)

## internå‡ºé‡åŸç†

jå‚è§dkçš„æºç ï¼š<http://hg.openjdk.java.net/jdk8u/jdk8u/hotspot/file/5bd0e0bcb152/src/share/vm/classfile/symbolTable.cpp>

ï¼ˆå…·ä½“ä»£ç ç•¥ï¼‰

## G1å»é‡

å¯ä»¥ä½¿ç”¨ä»¥ä¸‹çš„jvmå‚æ•°å¼€å¯G1åƒåœ¾å›æ”¶å™¨ï¼Œå¹¶å¼€å¯å­—ç¬¦ä¸²å»é‡åŠŸèƒ½ã€‚
```
-XX:+UseG1GC
-XX:+UseStringDeduplication
```

åŸç†æ˜¯è®©å¤šä¸ªå­—ç¬¦ä¸²å¯¹è±¡å¼•ç”¨åŒä¸€ä¸ªcharæ•°ç»„æ¥è¾¾åˆ°èŠ‚çœå†…å­˜çš„ç›®çš„ã€‚

![](å­¦ä¹ ç¬”è®°ï¼šStringTable.assets/b8da250d.png)

ç‰¹ç‚¹
* ç”±G1åƒåœ¾å›æ”¶å™¨åœ¨minor gcjé˜¶æ®µè‡ªåŠ¨åˆ†æä¼˜åŒ–ï¼Œä¸éœ€è¦ç¨‹åºå‘˜è‡ªå·±å¹²é¢„ã€‚
* åªæœ‰é’ˆå¯¹é‚£äº›å¤šæ¬¡å›æ”¶è¿˜ä¸æ­»çš„å­—ç¬¦ä¸²å¯¹è±¡ï¼Œæ‰ä¼šè¿›è¡Œå»é‡ä¼˜åŒ–ï¼Œå¯ä»¥é€šè¿‡jvmå‚æ•°`-XX:StringDeduplicationAgeThreshold=n`æ¥è°ƒæ•´ã€‚
* å¯ä»¥é€šè¿‡jvmå‚æ•°`-XX:+PringStringDeduplicationStatictics`æŸ¥çœ‹G1å»é‡çš„ç»Ÿè®¡ä¿¡æ¯ã€‚
* ä¸è°ƒç”¨internå»é‡ç›¸æ¯”ï¼ŒG1å»é‡çš„å¥½å¤„åœ¨äºè‡ªåŠ¨ï¼Œä½†ç¼ºç‚¹æ˜¯å³ä½¿charæ•°ç»„ä¸é‡å¤ï¼Œå­—ç¬¦ä¸²æœ¬èº«è¿˜è¦å ç”¨ä¸€å®šçš„å†…å­˜ï¼ˆå¯¹è±¡å¤´ã€valueå¼•ç”¨ã€hashï¼‰ï¼Œinternå»é‡æ˜¯å­—ç¬¦ä¸²åªå­˜ä¸€ä»½ï¼Œæ›´çœå†…å­˜ã€‚

## å®¶çš„å¤§å°

StringTableè¶³å¤Ÿå¤§ï¼Œæ‰èƒ½å‘æŒ¥æ€§èƒ½ä¼˜åŠ¿ï¼Œå¤§æ„å‘³ç€Stringåœ¨hashè¡¨ä¸­å†²çªå‡å°‘ï¼Œé“¾è¡¨çŸ­ï¼Œæ€§èƒ½é«˜ã€‚

* å¯ä»¥é€šè¿‡jvmå‚æ•°`-XX:+PrintStringTableStatistics`æ¥æŸ¥çœ‹StringTableçš„å¤§å°ï¼ŒJDK8ä¸­çš„é»˜è®¤å¤§å°æ˜¯60013.
* è¦æ³¨æ„StringTableåº•å±‚çš„hashè¡¨åœ¨JVMå¯åŠ¨åå°±å›ºå®šä¸å˜äº†ã€‚
* è¿™ä¸ªå“ˆå¸Œè¡¨å¯ä»¥åœ¨é“¾è¡¨é•¿åº¦å¤ªé•¿æ—¶è¿›è¡Œrehashï¼Œä½†ä¸æ˜¯åˆ©ç”¨æ‰©å®¹æ¥å®ç°çš„ï¼Œè€Œæ˜¯é€šè¿‡é‡æ–°è®¡ç®—å­—ç¬¦ä¸²çš„hashå€¼æ¥è®©å®ƒä»¬åˆ†å¸ƒå‡åŒ€ã€‚
* å¦‚æœæƒ³åœ¨å¯åŠ¨å‰è°ƒæ•´StringTableçš„å¤§å°ï¼Œå¯ä»¥é€šè¿‡jvmå‚æ•°`-XX:StringTableSize=n`æ¥æŒ‡å®šã€‚

## å­—ç¬¦ä¸²ä¹‹æ­»

å­—ç¬¦ä¸²ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œåªè¦æ˜¯å¯¹è±¡ï¼Œç»ˆç©¶é€ƒä¸è¿‡æ­»äº¡çš„å‘½è¿ã€‚å­—ç¬¦ä¸²å¯¹è±¡ä¸å…¶ä»–Javaæ¯’ç³»ä¸€æ ·ï¼Œåªè¦å¤±å»äº†åˆ©ç”¨ä»·å€¼ï¼Œå°±ä¼šè¢«åƒåœ¾å›æ”¶ï¼Œæ— è®ºæ˜¯é‡ç”Ÿå­—ç¬¦ä¸²ï¼Œè¿˜æ˜¯å®¶å…»å­—ç¬¦ä¸²ã€‚

å¯ä»¥é€šè¿‡jvmå‚æ•°`-XX:+PrintStringTableStatistics -XX:+PrintGCDetails -verbose:gc`è¯æ˜å®¶å…»çš„å­—ç¬¦ä¸²ä¹Ÿèƒ½è¢«åƒåœ¾å›æ”¶ã€‚

# é¢è¯•é¢˜è®²è§£

## 1. åˆ¤æ–­è¾“å‡º

```
String str1 = "string";
String str2 = new String("string");
String str3 = str2.intern();

System.out.println(str1 == str2); //#1
System.out.println(str1 == str3); //#2
```

è§£ç­”ï¼š
* 1ï¼šfalseï¼Œå› ä¸ºåè€…æ˜¯å®ä¾‹åŒ–å‡ºæ¥çš„æ–°å¯¹è±¡ã€‚
* 2ï¼štrueï¼Œå› ä¸ºä¸¤è€…æ˜¯StringTableä¸­çš„åŒä¸€å¯¹è±¡ã€‚

## 2. åˆ¤æ–­è¾“å‡º

```
String baseStr = "baseStr";
final String baseFinalStr = "baseStr";

String str1 = "baseStr01";
String str2 = "baseStr" + "01";
String str3 = baseStr + "01";
String str4 = baseFinalStr + "01";
String str5 = new String("baseStr01").intern();

System.out.println(str1 == str2); //#1
System.out.println(str1 == str3); //#2
System.out.println(str1 == str4); //#3
System.out.println(str1 == str5); //#4
```

è§£ç­”ï¼š
* 1ï¼štrueï¼Œå› ä¸ºå­—ç¬¦ä¸²æ‹¼æ¥åœ¨ç¼–è¯‘æ—¶å·²è¢«å¤„ç†ã€‚
* 2ï¼šfalseï¼Œå› ä¸ºå­—ç¬¦ä¸²æ‹¼æ¥åå¾—åˆ°äº†å®ä¾‹åŒ–çš„æ–°å¯¹è±¡ã€‚
* 3ï¼štrueï¼Œå› ä¸ºå­—ç¬¦ä¸²æ‹¼æ¥åœ¨ç¼–è¯‘æ—¶å·²è¢«å¤„ç†ã€‚
* 4ï¼štrueï¼Œå› ä¸ºä¸¤è€…æ˜¯StringTableä¸­çš„åŒä¸€å¯¹è±¡ã€‚

## 3. åˆ¤æ–­è¾“å‡ºï¼ˆæ³¨æ„ç‰ˆæœ¬ï¼‰

```
String str2 = new String("str") + new String("01");
str2.intern();
String str1 = "str01";
System.out.println(str2 == str1); //#1
```

è§£ç­”ï¼š
* 1ï¼šï¼ˆJDK6ï¼‰falseï¼Œå› ä¸ºå‰è€…å¹¶æœªè¢«æ”¾å…¥StringTableä¸­ã€‚
* 1ï¼šï¼ˆJDK7ä»¥ä¸Šï¼‰trueï¼Œå› ä¸ºä¸¤è€…æ˜¯StringTableä¸­çš„åŒä¸€å¯¹è±¡ã€‚

## 4. åˆ¤æ–­è¾“å‡º

```
String str1 = "str01";
String str2 = new String("str") + new String("01");
str2.intern();
System.out.println(str2 == str1); //#1
```

è§£ç­”ï¼š
* 1ï¼šfalseï¼Œå› ä¸ºå‰è€…å¹¶æœªè¢«æ”¾å…¥StringTableä¸­ï¼ŒStringTableä¸­å·²æœ‰ç›¸åŒçš„å¯¹è±¡ã€‚

## 5. `String s = new String("xyz")`åˆ›å»ºäº†å‡ ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ï¼Ÿ

è§£ç­”ï¼š
* ä¸¤ä¸ªï¼Œä¸€ä¸ªåœ¨StringTableä¸­ï¼Œä¸€ä¸ªä¸åœ¨StringTableä¸­ã€‚

## 6. åˆ¤æ–­è¾“å‡º

```
String s1 = "abc";
String s2 = "abc";
System.out.println(s1 == s2); //#1
```

è§£ç­”ï¼š
* 1ï¼štrueï¼Œå› ä¸ºä¸¤è€…æ˜¯StringTableä¸­çš„åŒä¸€å¯¹è±¡ã€‚

## 7. åˆ¤æ–­è¾“å‡º

```
String s1 = new String("abc");
String s2 = new String("abc");
System.out.println(s1 == s2); //#1
```

è§£ç­”ï¼š
* 1ï¼šfalseï¼Œå› ä¸ºä¸¤è€…éƒ½æ˜¯å®ä¾‹åŒ–å‡ºæ¥çš„æ–°å¯¹è±¡ï¼Œä¸å¯èƒ½ç›¸ç­‰ã€‚

## 8. åˆ¤æ–­è¾“å‡º

```
String s1 = "abc";
String s2 = "a";
String s3 = "bc";
String s4 = s2 + s4;
System.out.println(s1 == s4); //#1 
```

è§£ç­”ï¼š
* 1ï¼šfalseï¼Œå› ä¸ºåè€…æœ¬è´¨ä¸Šæ˜¯é€šè¿‡StringBuilderæ‹¼æ¥å‡ºæ¥çš„æ–°å­—ç¬¦ä¸²ã€‚

## 9. åˆ¤æ–­è¾“å‡º

```
String s1 = "abc";
final String s2 = "a";
final String s3 = "bc";
String s4 = s2 + s4;
System.out.println(s1 == s4); //#1 
```

è§£ç­”ï¼š
* 1ï¼štrueï¼Œå› ä¸ºåè€…åœ¨ç¼–è¯‘æ—¶å·²å¤„ç†å­—ç¬¦ä¸²çš„æ‹¼æ¥ï¼Œä¸¤è€…æ˜¯StringTableä¸­çš„åŒä¸€å¯¹è±¡ã€‚

## 10. åˆ¤æ–­è¾“å‡º

```
String s = new String("abc");
String s1 = "abc";
String s2 = new String("abc");
System.out.println(s == s1.intern()); //#1
System.out.println(s == s2.intern()); //#2
System.out.println(s1 == s2.intern()); //#3
```

è§£ç­”ï¼š
* 1ï¼šfalseï¼Œå› ä¸ºå‰è€…æ˜¯å®ä¾‹åŒ–å‡ºæ¥çš„æ–°å¯¹è±¡ï¼Œåè€…æ˜¯StringTableä¸­çš„å¯¹è±¡ã€‚
* 2ï¼šfalseï¼šå› ä¸ºå‰è€…æ˜¯å®ä¾‹åŒ–å‡ºæ¥çš„æ–°å¯¹è±¡ï¼Œåè€…æ˜¯StringTableä¸­çš„å¯¹è±¡ã€‚
* 3ï¼štrueï¼šä¸¤è€…æ˜¯StringTableä¸­çš„åŒä¸€å¯¹è±¡ã€‚
